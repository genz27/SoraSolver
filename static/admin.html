<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - Cloudflare Solver</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, sans-serif; background: #0a0a0a; color: #e5e5e5; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 24px; }
        h1 { font-size: 22px; margin-bottom: 24px; color: #fff; display: flex; align-items: center; gap: 16px; }
        h1 a { font-size: 14px; color: #60a5fa; text-decoration: none; }
        h1 a:hover { text-decoration: underline; }
        .card { background: #171717; border: 1px solid #262626; border-radius: 12px; padding: 24px; margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 600; color: #fff; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #262626; }
        .form-row { display: flex; gap: 12px; margin-bottom: 16px; align-items: center; }
        .form-row label { width: 140px; font-size: 14px; color: #a3a3a3; flex-shrink: 0; }
        .form-row input { flex: 1; padding: 10px 14px; background: #262626; border: 1px solid #404040; border-radius: 6px; font-size: 14px; color: #fff; }
        .form-row input:focus { outline: none; border-color: #60a5fa; }
        .form-row input::placeholder { color: #737373; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 500; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.85; }
        .btn-primary { background: #3b82f6; color: #fff; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #262626; }
        th { color: #a3a3a3; font-weight: 500; }
        td { color: #e5e5e5; }
        .key-text { font-family: monospace; font-size: 12px; max-width: 240px; overflow: hidden; text-overflow: ellipsis; color: #a3a3a3; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .badge-green { background: rgba(34,197,94,0.15); color: #4ade80; }
        .badge-red { background: rgba(239,68,68,0.15); color: #f87171; }
        .msg { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .msg-success { background: rgba(34,197,94,0.15); color: #4ade80; border: 1px solid rgba(34,197,94,0.3); }
        .msg-error { background: rgba(239,68,68,0.15); color: #f87171; border: 1px solid rgba(239,68,68,0.3); }
        .hidden { display: none; }
        
        .login-wrap { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 24px; }
        .login-card { width: 360px; }
        .login-card h1 { justify-content: center; margin-bottom: 32px; }
        .login-card .form-row { flex-direction: column; align-items: stretch; }
        .login-card .form-row label { width: auto; margin-bottom: 6px; }
        .login-card .btn { width: 100%; margin-top: 8px; }
    </style>
</head>
<body>
    <div id="login-page" class="login-wrap">
        <div class="card login-card">
            <h1>管理后台</h1>
            <div id="login-msg" class="msg hidden"></div>
            <div class="form-row">
                <label>用户名</label>
                <input type="text" id="username" value="admin" placeholder="请输入用户名">
            </div>
            <div class="form-row">
                <label>密码</label>
                <input type="password" id="password" placeholder="请输入密码">
            </div>
            <button class="btn btn-primary" onclick="login()">登录</button>
        </div>
    </div>
    
    <div id="admin-page" class="container hidden">
        <h1>管理后台 <a href="/">← 返回首页</a></h1>
        
        <div id="msg" class="msg hidden"></div>
        
        <div class="card">
            <div class="card-title">系统配置</div>
            <div id="config-form"></div>
            <button class="btn btn-primary" onclick="saveConfig()">保存配置</button>
        </div>
        
        <div class="card">
            <div class="card-title">API Key 管理</div>
            <div class="form-row" style="margin-bottom:20px;">
                <input type="text" id="new-key-name" placeholder="Key 名称（可选）" style="flex:1;">
                <button class="btn btn-primary" onclick="addKey()">添加 Key</button>
            </div>
            <table>
                <thead>
                    <tr><th>名称</th><th>Key</th><th>状态</th><th>操作</th></tr>
                </thead>
                <tbody id="keys-table"></tbody>
            </table>
        </div>
        
        <div class="card">
            <div class="card-title">修改密码</div>
            <div class="form-row">
                <label>新密码</label>
                <input type="password" id="new-password" placeholder="请输入新密码">
            </div>
            <div class="form-row">
                <label>确认密码</label>
                <input type="password" id="confirm-password" placeholder="请再次输入密码">
            </div>
            <button class="btn btn-primary" onclick="changePassword()">修改密码</button>
        </div>
    </div>
    
    <script>
        let token = localStorage.getItem('admin_token');
        
        function showMsg(el, msg, isError) {
            el.textContent = msg;
            el.className = 'msg ' + (isError ? 'msg-error' : 'msg-success');
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }
        
        async function api(path, method = 'GET', body = null) {
            const opts = { method, headers: { 'Authorization': 'Bearer ' + token } };
            if (body) {
                opts.headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(body);
            }
            const res = await fetch('/api' + path, opts);
            if (res.status === 401) {
                localStorage.removeItem('admin_token');
                document.getElementById('admin-page').classList.add('hidden');
                document.getElementById('login-page').classList.remove('hidden');
                return null;
            }
            return res.json();
        }
        
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                
                console.log('Login response:', data);
                
                if (data.success && data.token) {
                    token = data.token;
                    localStorage.setItem('admin_token', token);
                    console.log('Token saved, reloading page...');
                    // 刷新页面让初始化逻辑重新检测 token
                    window.location.reload();
                } else {
                    showMsg(document.getElementById('login-msg'), data.message || '登录失败', true);
                }
            } catch (e) {
                console.error('Login error:', e);
                showMsg(document.getElementById('login-msg'), '网络错误', true);
            }
        }
        
        async function showAdmin() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('admin-page').classList.remove('hidden');
            await loadConfig();
            await loadKeys();
        }
        
        async function loadConfig() {
            const data = await api('/config');
            if (!data) return;
            const form = document.getElementById('config-form');
            form.innerHTML = '';
            for (const [key, info] of Object.entries(data)) {
                form.innerHTML += `
                    <div class="form-row">
                        <label title="${info.description || ''}">${key}</label>
                        <input type="text" data-key="${key}" value="${info.value || ''}">
                    </div>
                `;
            }
        }
        
        async function saveConfig() {
            const inputs = document.querySelectorAll('#config-form input');
            const cfg = {};
            inputs.forEach(inp => cfg[inp.dataset.key] = inp.value);
            await api('/config', 'POST', cfg);
            showMsg(document.getElementById('msg'), '配置已保存');
        }
        
        async function loadKeys() {
            const data = await api('/keys');
            if (!data) return;
            const tbody = document.getElementById('keys-table');
            tbody.innerHTML = data.map(k => `
                <tr>
                    <td>${k.name || '-'}</td>
                    <td class="key-text" title="${k.key}">${k.key}</td>
                    <td><span class="badge ${k.enabled ? 'badge-green' : 'badge-red'}">${k.enabled ? '启用' : '禁用'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="toggleKey(${k.id}, ${!k.enabled})">${k.enabled ? '禁用' : '启用'}</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteKey(${k.id})">删除</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function addKey() {
            const name = document.getElementById('new-key-name').value;
            await api('/keys', 'POST', { name });
            document.getElementById('new-key-name').value = '';
            await loadKeys();
            showMsg(document.getElementById('msg'), 'Key 已添加');
        }
        
        async function toggleKey(id, enabled) {
            await api('/keys/' + id, 'PUT', { enabled });
            await loadKeys();
        }
        
        async function deleteKey(id) {
            if (!confirm('确定删除此 Key？')) return;
            await api('/keys/' + id, 'DELETE');
            await loadKeys();
        }
        
        async function changePassword() {
            const pwd = document.getElementById('new-password').value;
            const cfm = document.getElementById('confirm-password').value;
            if (pwd !== cfm) {
                showMsg(document.getElementById('msg'), '两次密码不一致', true);
                return;
            }
            if (!pwd) {
                showMsg(document.getElementById('msg'), '请输入新密码', true);
                return;
            }
            await api('/password', 'POST', { password: pwd });
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            showMsg(document.getElementById('msg'), '密码已修改');
        }
        
        // 初始化：检查是否已登录
        if (token) {
            api('/config').then(data => {
                if (data) showAdmin();
            });
        }
    </script>
</body>
</html>

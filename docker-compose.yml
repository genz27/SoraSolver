version: '3.8'

services:
  cloudflare-solver:
    build: .
    ports:
      - "8005:8005"
    volumes:
      # 挂载数据目录，持久化配置和数据库
      - ./data:/app/data
    environment:
      - MAX_WORKERS=3
      - POOL_SIZE=2
      - SEMAPHORE_LIMIT=3
    # 关键：增加共享内存，Chrome 需要
    shm_size: '2gb'
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 高并发场景：多实例 + 负载均衡
  # cloudflare-solver-2:
  #   build: .
  #   environment:
  #     - MAX_WORKERS=3
  #     - POOL_SIZE=2
  #   shm_size: '2gb'
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 4G

  # nginx:
  #   image: nginx:alpine
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #   depends_on:
  #     - cloudflare-solver
  #     - cloudflare-solver-2
